---
meta:
  productName: "terraform-aws-executors"
  owners:
    - "sourcegraph/release"
  repository: "github.com/sourcegraph/terraform-aws-executors"
requirements:
  - name: "comby exists"
    cmd: "which comby"
    fixInstructions: "install comby"
  - name: "GitHub cli exists"
    cmd: "which gh"
    fixInstructions: "install GitHub cli"

internal:
  create:
    steps:
      minor:
        - name: generate required files for release process
          cmd: |
            # get previous tag we need to replace
            git describe --tags "$(git rev-list --tags --max-count=1)" | sed 's/v//' > prev_tag
            # convert the tag to the image family format which uses hipens and is only for `major-minor`
            echo "{{tag}}" | grep -o -E "[[:digit:]]+\.[[:digit:]]+" | sed 's/\./-/' > family_tag
        - name: "update links in READMEs"
          cmd: comby -in-place "$(cat prev_tag)" '{{tag}}' README.md
        - name: "update version in examples"
          cmd: comby "\"$(cat prev_tag)\"" '"{{tag}}"' -i -f .tf -exclude providers.tf
        - name: "update executors docker-mirror image name"
          cmd: comby '["sourcegraph-executors-docker-mirror-:[~\d+-\d+]-*"]' "[\"sourcegraph-executors-docker-mirror-$(cat family_tag)-*\"]" -i -f .tf
        - name: "update executors image name"
          cmd: comby '["sourcegraph-executors-:[~\d+-\d+]-*"]' "[\"sourcegraph-executors-$(cat family_tag)-*\"]" -i -f .tf
        - name: "remove generated files"
          cmd: |
            rm -vf family_tag
            rm -vf prev_tag
        - name: "git:branch"
          cmd: |
            branch="wb/wip_{{version}}"
            git switch -c "${branch}"
            git commit -am 'release-minor: {{version}}' -m '{{config}}'
      major:
        - name: generate required files for release process
          cmd: |
            # get previous tag we need to replace
            git describe --tags "$(git rev-list --tags --max-count=1)" | sed 's/v//' > prev_tag
            # convert the tag to the image family format which uses hipens and is only for `major-minor`
            echo "{{tag}}" | grep -o -E "[[:digit:]]+\.[[:digit:]]+" | sed 's/\./-/' > family_tag
        - name: "update links in READMEs"
          cmd: comby -in-place "$(cat prev_tag)" '{{tag}}' README.md
        - name: "update version in examples"
          cmd: comby "\"$(cat prev_tag)\"" '"{{tag}}"' -i -f .tf -exclude providers.tf
        - name: "update executors docker-mirror image name"
          cmd: comby '["sourcegraph-executors-docker-mirror-:[~\d+-\d+]-*"]' "[\"sourcegraph-executors-docker-mirror-$(cat family_tag)-*\"]" -i -f .tf
        - name: "update executors image name"
          cmd: comby '["sourcegraph-executors-:[~\d+-\d+]-*"]' "[\"sourcegraph-executors-$(cat family_tag)-*\"]" -i -f .tf
        - name: "remove generated files"
          cmd: |
            rm -vf family_tag
            rm -vf prev_tag
        - name: "git:branch"
          cmd: |
            branch="wb/wip_{{version}}"
            git switch -c "${branch}"
            git commit -am 'release-major: {{version}}' -m '{{config}}'

  finalize:
    steps:
        - name: "create new branch"
          cmd: git switch "wb/wip-release-{{tag}}"
        - name: "add changes branch"
          cmd: "git commit -am 'WB-WIP: Test Release {{tag}}' -m 'This is a Test release'"

          cmd: "git tag -a {{tag}} -m 'WIP Release {{tag}}'"
        - name: "push branch"
          cmd: "git push origin wb/wip-release-{{tag}}"
        - name: "create release PR"
          cmd: gh pr create --draft --fill
test:
  steps:
    - name: "correct amount of new version tags in README"
      cmd: |
        count=$(grep -c '{{tag}}' README.md)
        expected=8
        if [[ ${count} -ne ${expected} ]]; then
          echo "expected ${expected} new version tags of \"{{tag}}\" in README.md, got ${count}"
          exit 1
        fi
    - name: "correct amount of .tf files"
      cmd: |
        count=$(comby -match-only '"{{tag}}"' '' -f .tf | wc -l)
        expected=6
        if [[ ${count} -ne ${expected} ]]; then
          echo "expected ${expected} .tf files to be updated with \"{{tag}}\" but got ${count}"
          exit 1
        fi
    - name: "sourcegraph-executors-docker-mirror image family has correct version"
      cmd: |
        echo "{{tag}}" | grep -o -E "[[:digit:]]+\.[[:digit:]]+" | sed 's/\./-/' > family_tag
        trap 'rm -rf family_tag' EXIT
        count=$(comby -match-only "[\"sourcegraph-executors-docker-mirror-$(cat family_tag)-*\"]" '' -f .tf | wc -l)
        expected=1
        if [[ ${count} -ne ${expected} ]]; then
          echo "expected ${expected} file to have the correct image family set but got but got ${count} files"
          exit 1
        fi
    - name: "sourcegraph-executors image family has correct version"
      cmd: |
        echo "{{tag}}" | grep -o -E "[[:digit:]]+\.[[:digit:]]+" | sed 's/\./-/' > family_tag
        trap 'rm -rf family_tag' EXIT
        count=$(comby -match-only "[\"sourcegraph-executors-$(cat family_tag)-*\"]" '' -f .tf | wc -l)
        expected=1
        if [[ ${count} -ne ${expected} ]]; then
          echo "expected ${expected} file to have the correct image family set but got but got ${count} files"
          exit 1
        fi

promoteToPublic:
  create:
    steps:
      - name: generate required files for release process
        cmd: |
          # get previous tag we need to replace
          git describe --tags "$(git rev-list --tags --max-count=1)" | sed 's/v//' > prev_tag
          # convert the tag to the image family format which uses hipens and is only for `major-minor`
          echo "{{tag}}" | grep -o -E "[[:digit:]]+\.[[:digit:]]+" | sed 's/\./-/' > family_tag
      - name: "update links in READMEs"
        cmd: comby -in-place "$(cat prev_tag)" '{{tag}}' README.md
      - name: "update version in examples"
        cmd: comby "\"$(cat prev_tag)\"" '"{{tag}}"' -i -f .tf -exclude providers.tf
      - name: "update executors docker-mirror image name"
        cmd: comby '["sourcegraph-executors-docker-mirror-:[~\d+-\d+]-*"]' "[\"sourcegraph-executors-docker-mirror-$(cat family_tag)-*\"]" -i -f .tf
      - name: "update executors image name"
        cmd: comby '["sourcegraph-executors-:[~\d+-\d+]-*"]' "[\"sourcegraph-executors-$(cat family_tag)-*\"]" -i -f .tf
      - name: "remove generated files"
        cmd: |
          rm -vf family_tag
          rm -vf prev_tag
      - name: "git:branch"
        cmd: |
          branch="wb/promote_wip_{{version}}"
          git switch -c "${branch}"
          git commit -am 'promote-release: {{version}}' -m '{{config}}'
      - name: "git:push"
        cmd: git push origin wb/promote_wip_{{version}}
      - name: "GitHub:create PR"
        cmd: |
          gh pr create -f -t "PRETEND PROMOTE RELEASE - release: build {{version}}"
